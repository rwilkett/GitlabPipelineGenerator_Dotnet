@page "/gitlab"
@using GitlabPipelineGenerator.Web.Models
@using GitlabPipelineGenerator.Core.Interfaces
@using GitlabPipelineGenerator.Core.Models.GitLab
@inject IGitLabProjectService GitLabProjectService
@inject IProjectAnalysisService ProjectAnalysisService
@inject IIntelligentPipelineGenerator PipelineGenerator
@inject IJSRuntime JSRuntime
@inject IGitLabProjectService GitLabProjectService
@inject IProjectAnalysisService ProjectAnalysisService
@inject IIntelligentPipelineGenerator PipelineGenerator

<PageTitle>GitLab Pipeline Generator</PageTitle>

<h1>GitLab Pipeline Generator</h1>

@if (projects == null && analysisResult == null)
{
    <EditForm Model="connectionModel" OnValidSubmit="HandleConnect">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-3">
            <label for="token">GitLab Personal Access Token:</label>
            <InputText id="token" type="password" class="form-control" @bind-Value="connectionModel.Token" />
            <small class="form-text text-muted">Create a token at GitLab ‚Üí User Settings ‚Üí Access Tokens with 'read_api' and 'read_repository' scopes</small>
        </div>

        <div class="form-group mb-3">
            <label for="groupId">Group ID:</label>
            <InputText id="groupId" class="form-control" @bind-Value="connectionModel.GroupId" placeholder="e.g., 12345" />
            <small class="form-text text-muted">Enter the GitLab group ID (numeric) to list projects from</small>
        </div>

        <button type="submit" class="btn btn-primary" disabled="@isConnecting">
            @if (isConnecting)
            {
                <span class="spinner-border spinner-border-sm" role="status"></span>
                <span>Connecting...</span>
            }
            else
            {
                <span>Connect to GitLab</span>
            }
        </button>
    </EditForm>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
}
else if (projects != null && analysisResult == null)
{
    <h2>Group: @groupName (@connectionModel.GroupId)</h2>
    
    <button class="btn btn-secondary mb-3" @onclick="BackToConnection">‚Üê Back to Connection</button>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(activeTabId == "main" ? "active" : "")" @onclick="@(() => SetActiveTab("main"))">Main</button>
        </li>
        @foreach (var tab in tabs)
        {
            <li class="nav-item">
                <button class="nav-link @(activeTabId == tab.Id ? "active" : "")" @onclick="() => SetActiveTab(tab.Id)">
                    @tab.Title
                    <button class="btn btn-sm ms-2" @onclick="() => CloseTab(tab.Id)" @onclick:stopPropagation="true">√ó</button>
                </button>
            </li>
        }
    </ul>

    <!-- Tab Content -->
    @if (activeTabId == "main")
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span>Page @currentPage</span>
            <div>
                <button class="btn btn-outline-primary me-2" @onclick="PreviousPage" disabled="@(currentPage == 1)">Previous</button>
                <button class="btn btn-outline-primary" @onclick="NextPage" disabled="@(!hasMoreProjects && !hasMoreSubgroups)">Next</button>
            </div>
        </div>

        @if (subgroups?.Any() == true)
        {
            <h4>Subgroups</h4>
            <div class="row mb-4">
                @foreach (var subgroup in subgroups)
                {
                    <div class="col-md-6 mb-3">
                        <div class="card border-info" style="cursor: pointer;" @onclick="() => OpenSubgroupTab(subgroup)">
                            <div class="card-body">
                                <h5 class="card-title">üìÅ @subgroup.Name</h5>
                                <p class="card-text">
                                    <strong>Path:</strong> @subgroup.FullPath<br>
                                    @if (!string.IsNullOrEmpty(subgroup.Description))
                                    {
                                        <strong>Description:</strong> @subgroup.Description<br>
                                    }
                                    <strong>URL:</strong> <a href="@subgroup.WebUrl" target="_blank" @onclick:stopPropagation="true">@subgroup.WebUrl</a>
                                </p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        @if (projects?.Any() == true)
        {
            <h4>Projects</h4>
            <div class="row">
                @foreach (var project in projects)
                {
                    <div class="col-md-6 mb-3">
                        <div class="card" style="cursor: pointer;" @onclick="() => OpenProjectTab(project)">
                            <div class="card-body">
                                <h5 class="card-title">@project.Name</h5>
                                <p class="card-text">
                                    <strong>Path:</strong> @project.FullPath<br>
                                    @if (!string.IsNullOrEmpty(project.Description))
                                    {
                                        <strong>Description:</strong> @project.Description<br>
                                    }
                                    <strong>URL:</strong> <a href="@project.WebUrl" target="_blank" @onclick:stopPropagation="true">@project.WebUrl</a>
                                </p>
                                <button class="btn btn-primary" @onclick="() => AnalyzeProject(project.FullPath, project.Name)" @onclick:stopPropagation="true" disabled="@isAnalyzing">
                                    @if (isAnalyzing && analyzingProject == project.FullPath)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        <span>Analyzing...</span>
                                    }
                                    else
                                    {
                                        <span>Analyze Project</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        
        @if ((projects?.Any() != true) && (subgroups?.Any() != true))
        {
            <p>No projects or subgroups found in group "@groupName" (ID: @connectionModel.GroupId). Make sure the group ID is correct and you have access to its contents.</p>
        }
    }
    else
    {
        var currentTab = tabs.FirstOrDefault(t => t.Id == activeTabId);
        @if (currentTab != null)
        {
            @if (currentTab.Type == "group")
            {
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Page @currentTab.CurrentPage</span>
                    <div>
                        <button class="btn btn-outline-primary me-2" @onclick="() => PreviousTabPage(currentTab.Id)" disabled="@(currentTab.CurrentPage == 1)">Previous</button>
                        <button class="btn btn-outline-primary" @onclick="() => NextTabPage(currentTab.Id)" disabled="@(!currentTab.HasMoreProjects && !currentTab.HasMoreSubgroups)">Next</button>
                    </div>
                </div>

                @if (currentTab.Subgroups?.Any() == true)
                {
                    <h4>Subgroups</h4>
                    <div class="row mb-4">
                        @foreach (var subgroup in currentTab.Subgroups)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card border-info" style="cursor: pointer;" @onclick="() => OpenSubgroupTab(subgroup)">
                                    <div class="card-body">
                                        <h5 class="card-title">üìÅ @subgroup.Name</h5>
                                        <p class="card-text">
                                            <strong>Path:</strong> @subgroup.FullPath<br>
                                            @if (!string.IsNullOrEmpty(subgroup.Description))
                                            {
                                                <strong>Description:</strong> @subgroup.Description<br>
                                            }
                                            <strong>URL:</strong> <a href="@subgroup.WebUrl" target="_blank" @onclick:stopPropagation="true">@subgroup.WebUrl</a>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (currentTab.Projects?.Any() == true)
                {
                    <h4>Projects</h4>
                    <div class="row">
                        @foreach (var project in currentTab.Projects)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card" style="cursor: pointer;" @onclick="() => OpenProjectTab(project)">
                                    <div class="card-body">
                                        <h5 class="card-title">@project.Name</h5>
                                        <p class="card-text">
                                            <strong>Path:</strong> @project.FullPath<br>
                                            @if (!string.IsNullOrEmpty(project.Description))
                                            {
                                                <strong>Description:</strong> @project.Description<br>
                                            }
                                            <strong>URL:</strong> <a href="@project.WebUrl" target="_blank" @onclick:stopPropagation="true">@project.WebUrl</a>
                                        </p>
                                        <button class="btn btn-primary" @onclick="() => AnalyzeProject(project.FullPath, project.Name)" @onclick:stopPropagation="true" disabled="@isAnalyzing">
                                            @if (isAnalyzing && analyzingProject == project.FullPath)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                                <span>Analyzing...</span>
                                            }
                                            else
                                            {
                                                <span>Analyze Project</span>
                                            }
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (currentTab.Type == "project" && currentTab.Project != null)
            {
                <h4>Project: @currentTab.Project.Name</h4>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Path:</strong> @currentTab.Project.FullPath</p>
                        @if (!string.IsNullOrEmpty(currentTab.Project.Description))
                        {
                            <p><strong>Description:</strong> @currentTab.Project.Description</p>
                        }
                        <p><strong>URL:</strong> <a href="@currentTab.Project.WebUrl" target="_blank">@currentTab.Project.WebUrl</a></p>
                        <button class="btn btn-primary" @onclick="() => AnalyzeProject(currentTab.Project.FullPath, currentTab.Project.Name)" disabled="@isAnalyzing">
                            @if (isAnalyzing && analyzingProject == currentTab.Project.FullPath)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <span>Analyzing...</span>
                            }
                            else
                            {
                                <span>Analyze Project</span>
                            }
                        </button>
                    </div>
                </div>
            }
        }
    }
}
else if (analysisResult != null)
{
    <h1>Analysis Results</h1>
    
    <button class="btn btn-secondary mb-3" @onclick="BackToProjects">‚Üê Back to Projects</button>

    @if (analysisResult.Success)
    {
        <h2>Project: @analysisResult.ProjectName</h2>
        
        <div class="mb-4">
            <h3>Detected Configuration</h3>
            <p><strong>Project Type:</strong> @analysisResult.DetectedType</p>
            <p><strong>Framework:</strong> @analysisResult.Framework</p>
            <p><strong>Build Tool:</strong> @analysisResult.BuildTool</p>
            @if (!string.IsNullOrEmpty(analysisResult.Version))
            {
                <p><strong>Version:</strong> @analysisResult.Version</p>
            }
            
            @if (analysisResult.BuildCommands.Any())
            {
                <p><strong>Build Commands:</strong></p>
                <ul>
                    @foreach (var cmd in analysisResult.BuildCommands)
                    {
                        <li><code>@cmd</code></li>
                    }
                </ul>
            }
            
            @if (analysisResult.TestCommands.Any())
            {
                <p><strong>Test Commands:</strong></p>
                <ul>
                    @foreach (var cmd in analysisResult.TestCommands)
                    {
                        <li><code>@cmd</code></li>
                    }
                </ul>
            }
        </div>
        
        <h3>Generated GitLab CI/CD Pipeline</h3>
        <div class="yaml-output border p-3 bg-light" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; white-space: pre-wrap;">@analysisResult.YamlContent</div>
        
        <div class="mt-3">
            <button class="btn btn-success" @onclick="CopyToClipboard">Copy YAML to Clipboard</button>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <h3>Analysis Failed</h3>
            <p>@analysisResult.ErrorMessage</p>
        </div>
    }
}

@code {
    private GitLabConnectionModel connectionModel = new();
    private List<ProjectItem>? projects;
    private List<SubgroupItem>? subgroups;
    private AnalysisResultModel? analysisResult;
    private string? groupName;
    private bool isConnecting = false;
    private bool isAnalyzing = false;
    private string? analyzingProject;
    private string? errorMessage;
    private int currentPage = 1;
    private int pageSize = 10;
    private bool hasMoreProjects = false;
    private bool hasMoreSubgroups = false;
    
    private List<TabItem> tabs = new();
    private string activeTabId = "main";
    private int tabCounter = 0;
    
    public class TabItem
    {
        public string Id { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty; // "group" or "project"
        public string GroupId { get; set; } = string.Empty;
        public ProjectItem? Project { get; set; }
        public List<ProjectItem>? Projects { get; set; }
        public List<SubgroupItem>? Subgroups { get; set; }
        public int CurrentPage { get; set; } = 1;
        public bool HasMoreProjects { get; set; }
        public bool HasMoreSubgroups { get; set; }
    }

    private async System.Threading.Tasks.Task HandleConnect()
    {
        isConnecting = true;
        errorMessage = null;

        try
        {
            // Create GitLab client with provided credentials
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            // Set the authenticated client on the service
            GitLabProjectService.SetAuthenticatedClient(gitlabClient);
            
            // Get group info
            var group = await gitlabClient.GetGroupAsync(connectionModel.GroupId);
            groupName = group.Name;
            
            // Get projects and subgroups
            await LoadPageData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            isConnecting = false;
        }
    }

    private async System.Threading.Tasks.Task AnalyzeProject(string projectPath, string projectName)
    {
        isAnalyzing = true;
        analyzingProject = projectPath;

        try
        {
            var gitlabProject = new GitLabProject
            {
                FullPath = projectPath,
                Name = projectName
            };

            var analysisOptions = new AnalysisOptions
            {
                AnalyzeFiles = true,
                AnalyzeDependencies = true,
                AnalyzeExistingCI = true,
                AnalyzeDeployment = true
            };

            var result = await ProjectAnalysisService.AnalyzeProjectAsync(gitlabProject, analysisOptions);
            var pipeline = await PipelineGenerator.GenerateFromAnalysisAsync(result);
            var yamlContent = PipelineGenerator.SerializeToYaml(pipeline);

            analysisResult = new AnalysisResultModel
            {
                ProjectName = projectName,
                DetectedType = result.DetectedType.ToString(),
                Framework = result.Framework?.Name ?? "Unknown",
                BuildTool = result.BuildConfig?.BuildTool ?? "Unknown",
                Version = result.Framework?.Version ?? "",
                BuildCommands = result.BuildConfig?.BuildCommands ?? new(),
                TestCommands = result.BuildConfig?.TestCommands ?? new(),
                YamlContent = yamlContent,
                Success = true
            };
        }
        catch (Exception ex)
        {
            analysisResult = new AnalysisResultModel
            {
                ProjectName = projectName,
                Success = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            isAnalyzing = false;
            analyzingProject = null;
        }
    }

    private async Task LoadPageData()
    {
        var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
            connectionModel.ServerUrl, 
            connectionModel.Token);
        
        // Load projects
        var projectsResult = await gitlabClient.GetGroupProjectsAsync(connectionModel.GroupId, pageSize, currentPage);
        projects = projectsResult.Select(p => new ProjectItem
        {
            Id = p.Id,
            Name = p.Name,
            FullPath = p.PathWithNamespace,
            Description = p.Description ?? "",
            WebUrl = p.WebUrl
        }).ToList();
        hasMoreProjects = projectsResult.Count == pageSize;
        
        // Load subgroups
        var subgroupsResult = await gitlabClient.GetSubgroupsAsync(connectionModel.GroupId, pageSize, currentPage);
        subgroups = subgroupsResult.Select(g => new SubgroupItem
        {
            Id = g.Id,
            Name = g.Name,
            FullPath = g.FullPath,
            Description = g.Description ?? "",
            WebUrl = g.WebUrl
        }).ToList();
        hasMoreSubgroups = subgroupsResult.Count == pageSize;
    }
    
    private async Task NextPage()
    {
        currentPage++;
        await LoadPageData();
    }
    
    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadPageData();
        }
    }

    private async Task OpenSubgroupTab(SubgroupItem subgroup)
    {
        var tabId = $"group_{++tabCounter}";
        var tab = new TabItem
        {
            Id = tabId,
            Title = subgroup.Name,
            Type = "group",
            GroupId = subgroup.Id.ToString()
        };
        
        tabs.Add(tab);
        activeTabId = tabId;
        
        await LoadTabData(tab);
    }
    
    private void OpenProjectTab(ProjectItem project)
    {
        var tabId = $"project_{++tabCounter}";
        var tab = new TabItem
        {
            Id = tabId,
            Title = project.Name,
            Type = "project",
            Project = project
        };
        
        tabs.Add(tab);
        activeTabId = tabId;
    }
    
    private async Task LoadTabData(TabItem tab)
    {
        if (tab.Type == "group")
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            var projectsResult = await gitlabClient.GetGroupProjectsAsync(tab.GroupId, pageSize, tab.CurrentPage);
            tab.Projects = projectsResult.Select(p => new ProjectItem
            {
                Id = p.Id,
                Name = p.Name,
                FullPath = p.PathWithNamespace,
                Description = p.Description ?? "",
                WebUrl = p.WebUrl
            }).ToList();
            tab.HasMoreProjects = projectsResult.Count == pageSize;
            
            var subgroupsResult = await gitlabClient.GetSubgroupsAsync(tab.GroupId, pageSize, tab.CurrentPage);
            tab.Subgroups = subgroupsResult.Select(g => new SubgroupItem
            {
                Id = g.Id,
                Name = g.Name,
                FullPath = g.FullPath,
                Description = g.Description ?? "",
                WebUrl = g.WebUrl
            }).ToList();
            tab.HasMoreSubgroups = subgroupsResult.Count == pageSize;
        }
    }
    
    private void SetActiveTab(string tabId)
    {
        activeTabId = tabId;
    }
    
    private void CloseTab(string tabId)
    {
        tabs.RemoveAll(t => t.Id == tabId);
        if (activeTabId == tabId)
        {
            activeTabId = tabs.Any() ? tabs.Last().Id : "main";
        }
    }
    
    private async Task NextTabPage(string tabId)
    {
        var tab = tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null)
        {
            tab.CurrentPage++;
            await LoadTabData(tab);
        }
    }
    
    private async Task PreviousTabPage(string tabId)
    {
        var tab = tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null && tab.CurrentPage > 1)
        {
            tab.CurrentPage--;
            await LoadTabData(tab);
        }
    }

    private void BackToConnection()
    {
        projects = null;
        subgroups = null;
        analysisResult = null;
        groupName = null;
        errorMessage = null;
        currentPage = 1;
        tabs.Clear();
        activeTabId = "main";
        tabCounter = 0;
    }

    private void BackToProjects()
    {
        analysisResult = null;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSavedSettings();
    }
    
    private async Task LoadSavedSettings()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gitlab-settings");
            if (!string.IsNullOrEmpty(json))
            {
                var saved = System.Text.Json.JsonSerializer.Deserialize<GitLabConnectionModel>(json);
                if (saved != null)
                {
                    connectionModel.ServerUrl = saved.ServerUrl;
                    connectionModel.Token = saved.Token;
                }
            }
        }
        catch
        {
            // Ignore errors loading settings
        }
    }

    private async System.Threading.Tasks.Task CopyToClipboard()
    {
        if (analysisResult?.YamlContent != null)
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", analysisResult.YamlContent);
            await JSRuntime.InvokeVoidAsync("alert", "YAML copied to clipboard!");
        }
    }
}