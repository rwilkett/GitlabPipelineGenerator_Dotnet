@page "/gitlab"
@using GitlabPipelineGenerator.Web.Models
@using GitlabPipelineGenerator.Core.Interfaces
@using GitlabPipelineGenerator.Core.Models.GitLab
@using GitlabPipelineGenerator.Web.Services
@using GitlabPipelineGenerator.Web.Components.Shared
@inject IGitLabProjectService GitLabProjectService
@inject IProjectAnalysisService ProjectAnalysisService
@inject IIntelligentPipelineGenerator PipelineGenerator
@inject IJSRuntime JSRuntime
@inject LoadingService LoadingService

<PageTitle>GitLab Pipeline Generator</PageTitle>

<h1>GitLab Pipeline Generator</h1>

@if (projects == null && analysisResult == null && searchResults == null)
{
    <GitLabConnectionForm 
        ConnectionModel="connectionModel" 
        IsConnecting="isConnecting" 
        IsSearching="isSearching" 
        @bind-SearchTerm="searchTerm" 
        OnConnect="HandleConnect" 
        OnSearch="HandleSearch" 
        OnSearchKeyPress="HandleSearchKeyPress" />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
}
else if ((projects != null || searchResults != null) && analysisResult == null)
{
    @if (!string.IsNullOrEmpty(groupName))
    {
        <h2>Group: @groupName (@connectionModel.GroupId)</h2>
    }
    else if (searchResults != null)
    {
        <h2>Search Results for "@searchTerm"</h2>
    }
    @if (mainGroupVariables != null && mainGroupVariables.TotalVariables > 0)
    {
        <div class="alert alert-info mb-3">
            <strong>Group CI/CD Variables:</strong> @mainGroupVariables.TotalVariables total
            @if (mainGroupVariables.ProtectedVariables > 0)
            {
                <span class="badge bg-warning ms-2">@mainGroupVariables.ProtectedVariables Protected</span>
            }
            @if (mainGroupVariables.MaskedVariables > 0)
            {
                <span class="badge bg-secondary ms-1">@mainGroupVariables.MaskedVariables Masked</span>
            }
            @if (mainGroupVariables.EnvironmentScopes.Count > 1)
            {
                <br><small>Environment Scopes: @string.Join(", ", mainGroupVariables.EnvironmentScopes)</small>
            }
        </div>
    }
    
    <button class="btn btn-secondary mb-3" @onclick="BackToConnection">‚Üê Back to Connection</button>
    @if (searchResults != null)
    {
        <button class="btn btn-outline-secondary mb-3 ms-2" @onclick="ClearSearch">Clear Search</button>
    }

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(activeTabId == "main" ? "active" : "")" @onclick="@(() => SetActiveTab("main"))">Main</button>
        </li>
        @foreach (var tab in tabs)
        {
            <li class="nav-item">
                <button class="nav-link @(activeTabId == tab.Id ? "active" : "")" @onclick="() => SetActiveTab(tab.Id)">
                    @tab.Title
                    <button class="btn btn-sm ms-2" @onclick="() => CloseTab(tab.Id)" @onclick:stopPropagation="true">√ó</button>
                </button>
            </li>
        }
    </ul>

    <!-- Tab Content -->
    @if (activeTabId == "main")
    {
        @if (searchResults == null)
        {
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Page @currentPage</span>
                <div>
                    <button class="btn btn-outline-primary me-2" @onclick="PreviousPage" disabled="@(currentPage == 1)">Previous</button>
                    <button class="btn btn-outline-primary" @onclick="NextPage" disabled="@(!hasMoreProjects && !hasMoreSubgroups)">Next</button>
                </div>
            </div>
        }

        @if (searchResults?.Groups?.Any() == true)
        {
            <h4>Groups</h4>
            <div class="row mb-4">
                @foreach (var group in searchResults.Groups)
                {
                    <GroupCard 
                        Group="@(new SubgroupItem { Id = group.Id, Name = group.Name, FullPath = group.FullPath, Description = group.Description, WebUrl = group.WebUrl })" 
                        ShowVariables="false" 
                        ShowBrowseButton="true" 
                        OnGroupClick="() => ConnectToGroup(group.Id.ToString(), group.Name)" 
                        OnViewSamlLinks="() => ViewSamlLinks(group.Id.ToString(), group.Name)" 
                        OnViewProvisionedUsers="() => ViewProvisionedUsers(group.Id.ToString(), group.Name)" 
                        OnViewSamlUsers="() => ViewSamlUsers(group.Id.ToString(), group.Name)" 
                        OnExportJson="() => ExportGroupJson(group.Id.ToString(), group.Name)" />
                }
            </div>
        }
        else if (subgroups?.Any() == true)
        {
            <h4>Subgroups</h4>
            <div class="row mb-4">
                @foreach (var subgroup in subgroups)
                {
                    <GroupCard 
                        Group="subgroup" 
                        Variables="subgroup.Variables" 
                        ShowVariables="true" 
                        ShowBrowseButton="false" 
                        OnGroupClick="() => OpenSubgroupTab(subgroup)" 
                        OnViewVariables="() => ShowVariables(subgroup.Variables!)" 
                        OnViewSamlLinks="() => ViewSamlLinks(subgroup.Id.ToString(), subgroup.Name)" 
                        OnViewProvisionedUsers="() => ViewProvisionedUsers(subgroup.Id.ToString(), subgroup.Name)" 
                        OnViewSamlUsers="() => ViewSamlUsers(subgroup.Id.ToString(), subgroup.Name)" 
                        OnExportJson="() => ExportGroupJson(subgroup.Id.ToString(), subgroup.Name)" />
                }
            </div>
        }

        @if (searchResults?.Projects?.Any() == true || projects?.Any() == true)
        {
            <h4>Projects</h4>
            <div class="row">
                @foreach (var project in (searchResults?.Projects ?? projects ?? new List<ProjectItem>()))
                {
                    <ProjectCard 
                        Project="project" 
                        IsAnalyzing="isAnalyzing" 
                        IsLoadingVariables="isLoadingVariables" 
                        AnalyzingProject="analyzingProject" 
                        LoadingVariablesFor="loadingVariablesFor" 
                        OnProjectClick="() => OpenProjectTab(project)" 
                        OnAnalyze="() => AnalyzeProject(project.FullPath, project.Name)" 
                        OnViewVariables="() => ViewProjectVariables(project.FullPath, project.Name)" />
                }
            </div>
        }
        
        @if (searchResults != null && (searchResults.Projects?.Any() != true) && (searchResults.Groups?.Any() != true))
        {
            <p>No projects or groups found for search term "@searchTerm".</p>
        }
        else if (searchResults == null && (projects?.Any() != true) && (subgroups?.Any() != true))
        {
            <p>No projects or subgroups found in group "@groupName" (ID: @connectionModel.GroupId). Make sure the group ID is correct and you have access to its contents.</p>
        }
    }
    else
    {
        var currentTab = tabs.FirstOrDefault(t => t.Id == activeTabId);
        @if (currentTab != null)
        {
            @if (currentTab.Type == "group")
            {
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Page @currentTab.CurrentPage</span>
                    <div>
                        <button class="btn btn-outline-primary me-2" @onclick="() => PreviousTabPage(currentTab.Id)" disabled="@(currentTab.CurrentPage == 1)">Previous</button>
                        <button class="btn btn-outline-primary" @onclick="() => NextTabPage(currentTab.Id)" disabled="@(!currentTab.HasMoreProjects && !currentTab.HasMoreSubgroups)">Next</button>
                    </div>
                </div>

                @if (currentTab.Subgroups?.Any() == true)
                {
                    <h4>Subgroups</h4>
                    <div class="row mb-4">
                        @foreach (var subgroup in currentTab.Subgroups)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card border-info" style="cursor: pointer;" @onclick="() => OpenSubgroupTab(subgroup)">
                                    <div class="card-body">
                                        <h5 class="card-title">üìÅ @subgroup.Name</h5>
                                        <p class="card-text">
                                            <strong>Path:</strong> @subgroup.FullPath<br>
                                            @if (!string.IsNullOrEmpty(subgroup.Description))
                                            {
                                                <strong>Description:</strong> @subgroup.Description<br>
                                            }
                                            <strong>URL:</strong> <a href="@subgroup.WebUrl" target="_blank" @onclick:stopPropagation="true">@subgroup.WebUrl</a><br>
                                            @if (subgroup.Variables != null && subgroup.Variables.TotalVariables > 0)
                                            {
                                                <strong>CI/CD Variables:</strong> @subgroup.Variables.TotalVariables
                                                @if (subgroup.Variables.ProtectedVariables > 0)
                                                {
                                                    <span class="badge bg-warning ms-1">@subgroup.Variables.ProtectedVariables Protected</span>
                                                }
                                                @if (subgroup.Variables.MaskedVariables > 0)
                                                {
                                                    <span class="badge bg-secondary ms-1">@subgroup.Variables.MaskedVariables Masked</span>
                                                }
                                                <br><button class="btn btn-sm btn-outline-info mt-2" @onclick="() => ShowVariables(subgroup.Variables!)" @onclick:stopPropagation="true">View Variables</button>
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (currentTab.Projects?.Any() == true)
                {
                    <h4>Projects</h4>
                    <div class="row">
                        @foreach (var project in currentTab.Projects)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card" style="cursor: pointer;" @onclick="() => OpenProjectTab(project)">
                                    <div class="card-body">
                                        <h5 class="card-title">@project.Name</h5>
                                        <p class="card-text">
                                            <strong>Path:</strong> @project.FullPath<br>
                                            @if (!string.IsNullOrEmpty(project.Description))
                                            {
                                                <strong>Description:</strong> @project.Description<br>
                                            }
                                            <strong>URL:</strong> <a href="@project.WebUrl" target="_blank" @onclick:stopPropagation="true">@project.WebUrl</a>
                                        </p>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" @onclick="() => AnalyzeProject(project.FullPath, project.Name)" @onclick:stopPropagation="true" disabled="@isAnalyzing">
                                                @if (isAnalyzing && analyzingProject == project.FullPath)
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                    <span>Analyzing...</span>
                                                }
                                                else
                                                {
                                                    <span>Analyze Project</span>
                                                }
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" @onclick="() => ViewProjectVariables(project.FullPath, project.Name)" @onclick:stopPropagation="true" disabled="@isLoadingVariables">
                                                @if (isLoadingVariables && loadingVariablesFor == project.FullPath)
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                                }
                                                else
                                                {
                                                    <span>Variables</span>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (currentTab.Type == "project" && currentTab.Project != null)
            {
                <h4>Project: @currentTab.Project.Name</h4>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Path:</strong> @currentTab.Project.FullPath</p>
                        @if (!string.IsNullOrEmpty(currentTab.Project.Description))
                        {
                            <p><strong>Description:</strong> @currentTab.Project.Description</p>
                        }
                        <p><strong>URL:</strong> <a href="@currentTab.Project.WebUrl" target="_blank">@currentTab.Project.WebUrl</a></p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @onclick="() => AnalyzeProject(currentTab.Project.FullPath, currentTab.Project.Name)" disabled="@isAnalyzing">
                                @if (isAnalyzing && analyzingProject == currentTab.Project.FullPath)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    <span>Analyzing...</span>
                                }
                                else
                                {
                                    <span>Analyze Project</span>
                                }
                            </button>
                            <button class="btn btn-outline-info" @onclick="() => ViewProjectVariables(currentTab.Project.FullPath, currentTab.Project.Name)" disabled="@isLoadingVariables">
                                @if (isLoadingVariables && loadingVariablesFor == currentTab.Project.FullPath)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                    <span>Loading...</span>
                                }
                                else
                                {
                                    <span>View Variables</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    }
}
else if (analysisResult != null)
{
    <AnalysisResults Result="analysisResult" OnBackToProjects="BackToProjects" />
}

<VariablesModal Show="showVariablesModal" Variables="selectedVariables" OnClose="CloseVariablesModal" />
<SamlGroupLinksModal Show="showSamlLinksModal" SamlLinks="selectedSamlLinks" OnClose="CloseSamlLinksModal" />
<ProvisionedUsersModal Show="showProvisionedUsersModal" Members="selectedProvisionedUsers" OnClose="CloseProvisionedUsersModal" />
<SamlUsersModal Show="showSamlUsersModal" Members="selectedSamlUsers" OnClose="CloseSamlUsersModal" />
<GroupExportModal @ref="exportModal" Show="showExportModal" GroupName="exportGroupName" OnClose="CloseExportModal" OnExport="HandleGroupExport" />

@code {
    private GitLabConnectionModel connectionModel = new();
    private List<ProjectItem>? projects;
    private List<SubgroupItem>? subgroups;
    private AnalysisResultModel? analysisResult;
    private string? groupName;
    private ProjectVariablesModel? mainGroupVariables;
    private bool isConnecting = false;
    private bool isAnalyzing = false;
    private string? analyzingProject;
    private string? errorMessage;
    private int currentPage = 1;
    private int pageSize = 10;
    private bool hasMoreProjects = false;
    private bool hasMoreSubgroups = false;
    
    private string searchTerm = string.Empty;
    private bool isSearching = false;
    private SearchResultsModel? searchResults;
    private bool isLoadingVariables = false;
    private string? loadingVariablesFor;
    
    private List<TabItem> tabs = new();
    private string activeTabId = "main";
    private int tabCounter = 0;
    private bool showVariablesModal = false;
    private ProjectVariablesModel? selectedVariables;
    private bool showSamlLinksModal = false;
    private List<SamlGroupLinkModel>? selectedSamlLinks;
    private bool showProvisionedUsersModal = false;
    private List<GitlabPipelineGenerator.GitLabApiClient.Models.Member>? selectedProvisionedUsers;
    private bool showSamlUsersModal = false;
    private List<GitlabPipelineGenerator.GitLabApiClient.Models.Member>? selectedSamlUsers;
    private bool showExportModal = false;
    private string exportGroupId = string.Empty;
    private string exportGroupName = string.Empty;
    private GroupExportModal? exportModal;
    
    public class TabItem
    {
        public string Id { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty; // "group" or "project"
        public string GroupId { get; set; } = string.Empty;
        public ProjectItem? Project { get; set; }
        public List<ProjectItem>? Projects { get; set; }
        public List<SubgroupItem>? Subgroups { get; set; }
        public int CurrentPage { get; set; } = 1;
        public bool HasMoreProjects { get; set; }
        public bool HasMoreSubgroups { get; set; }
        public ProjectVariablesModel? Variables { get; set; }
    }

    private async System.Threading.Tasks.Task HandleConnect()
    {
        isConnecting = true;
        errorMessage = null;
        LoadingService.SetLoading(true, "Connecting to GitLab...");

        try
        {
            // Create GitLab client with provided credentials
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            // Set the authenticated client on the service
            GitLabProjectService.SetAuthenticatedClient(gitlabClient);
            
            LoadingService.SetLoading(true, "Loading group information...");
            // Get group info
            var group = await gitlabClient.GetGroupAsync(connectionModel.GroupId);
            groupName = group.Name;
            
            // Get main group variables
            try
            {
                var groupVars = await gitlabClient.GetGroupVariablesAsync(connectionModel.GroupId);
                mainGroupVariables = new ProjectVariablesModel
                {
                    TotalVariables = groupVars.Count,
                    ProtectedVariables = groupVars.Count(v => v.Protected),
                    MaskedVariables = groupVars.Count(v => v.Masked),
                    EnvironmentScopes = groupVars.Select(v => v.EnvironmentScope).Distinct().ToList(),
                    Variables = groupVars.Select(v => new ProjectVariableModel
                    {
                        Key = v.Key,
                        VariableType = v.VariableType,
                        Protected = v.Protected,
                        Masked = v.Masked,
                        EnvironmentScope = v.EnvironmentScope,
                        Description = v.Description
                    }).ToList()
                };
            }
            catch
            {
                // Ignore errors fetching main group variables
            }
            
            LoadingService.SetLoading(true, "Loading projects and subgroups...");
            // Get projects and subgroups
            await LoadPageData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            isConnecting = false;
            LoadingService.SetLoading(false);
        }
    }

    private async System.Threading.Tasks.Task AnalyzeProject(string projectPath, string projectName)
    {
        isAnalyzing = true;
        analyzingProject = projectPath;
        LoadingService.SetLoading(true, $"Analyzing {projectName}...");

        try
        {
            var gitlabProject = new GitLabProject
            {
                FullPath = projectPath,
                Name = projectName
            };

            var analysisOptions = new AnalysisOptions
            {
                AnalyzeFiles = true,
                AnalyzeDependencies = true,
                AnalyzeExistingCI = true,
                AnalyzeDeployment = true,
                AnalyzeVariables = true
            };

            LoadingService.SetLoading(true, "Analyzing project structure...");
            var result = await ProjectAnalysisService.AnalyzeProjectAsync(gitlabProject, analysisOptions);
            
            LoadingService.SetLoading(true, "Generating pipeline...");
            var pipeline = await PipelineGenerator.GenerateFromAnalysisAsync(result);
            var yamlContent = PipelineGenerator.SerializeToYaml(pipeline);

            analysisResult = new AnalysisResultModel
            {
                ProjectName = projectName,
                DetectedType = result.DetectedType.ToString(),
                Framework = result.Framework?.Name ?? "Unknown",
                BuildTool = result.BuildConfig?.BuildTool ?? "Unknown",
                Version = result.Framework?.Version ?? "",
                BuildCommands = result.BuildConfig?.BuildCommands ?? new(),
                TestCommands = result.BuildConfig?.TestCommands ?? new(),
                YamlContent = yamlContent,
                Success = true,
                Variables = result.Variables != null ? new ProjectVariablesModel
                {
                    TotalVariables = result.Variables.TotalVariables,
                    ProtectedVariables = result.Variables.ProtectedVariables,
                    MaskedVariables = result.Variables.MaskedVariables,
                    EnvironmentScopes = result.Variables.EnvironmentScopes,
                    Variables = result.Variables.Variables.Select(v => new ProjectVariableModel
                    {
                        Key = v.Key,
                        VariableType = v.VariableType,
                        Protected = v.Protected,
                        Masked = v.Masked,
                        EnvironmentScope = v.EnvironmentScope,
                        Description = v.Description
                    }).ToList()
                } : null
            };
        }
        catch (Exception ex)
        {
            analysisResult = new AnalysisResultModel
            {
                ProjectName = projectName,
                Success = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            isAnalyzing = false;
            analyzingProject = null;
            LoadingService.SetLoading(false);
        }
    }

    private async Task LoadPageData()
    {
        var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
            connectionModel.ServerUrl, 
            connectionModel.Token);
        
        // Load projects
        var projectsResult = await gitlabClient.GetGroupProjectsAsync(connectionModel.GroupId, pageSize, currentPage);
        projects = projectsResult.Select(p => new ProjectItem
        {
            Id = p.Id,
            Name = p.Name,
            FullPath = p.PathWithNamespace,
            Description = p.Description ?? "",
            WebUrl = p.WebUrl
        }).ToList();
        hasMoreProjects = projectsResult.Count == pageSize;
        
        // Load subgroups with variables
        var subgroupsResult = await gitlabClient.GetSubgroupsAsync(connectionModel.GroupId, pageSize, currentPage);
        subgroups = new List<SubgroupItem>();
        foreach (var g in subgroupsResult)
        {
            var subgroup = new SubgroupItem
            {
                Id = g.Id,
                Name = g.Name,
                FullPath = g.FullPath,
                Description = g.Description ?? "",
                WebUrl = g.WebUrl
            };
            
            try
            {
                var groupVars = await gitlabClient.GetGroupVariablesAsync(g.Id.ToString());
                subgroup.Variables = new ProjectVariablesModel
                {
                    TotalVariables = groupVars.Count,
                    ProtectedVariables = groupVars.Count(v => v.Protected),
                    MaskedVariables = groupVars.Count(v => v.Masked),
                    EnvironmentScopes = groupVars.Select(v => v.EnvironmentScope).Distinct().ToList(),
                    Variables = groupVars.Select(v => new ProjectVariableModel
                    {
                        Key = v.Key,
                        VariableType = v.VariableType,
                        Protected = v.Protected,
                        Masked = v.Masked,
                        EnvironmentScope = v.EnvironmentScope,
                        Description = v.Description
                    }).ToList()
                };
            }
            catch
            {
                // Ignore errors fetching group variables
            }
            
            subgroups.Add(subgroup);
        }
        hasMoreSubgroups = subgroupsResult.Count == pageSize;
    }
    
    private async Task NextPage()
    {
        LoadingService.SetLoading(true, "Loading next page...");
        try
        {
            currentPage++;
            await LoadPageData();
        }
        finally
        {
            LoadingService.SetLoading(false);
        }
    }
    
    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            LoadingService.SetLoading(true, "Loading previous page...");
            try
            {
                currentPage--;
                await LoadPageData();
            }
            finally
            {
                LoadingService.SetLoading(false);
            }
        }
    }

    private async Task OpenSubgroupTab(SubgroupItem subgroup)
    {
        var tabId = $"group_{++tabCounter}";
        var tab = new TabItem
        {
            Id = tabId,
            Title = subgroup.Name,
            Type = "group",
            GroupId = subgroup.Id.ToString(),
            Variables = subgroup.Variables
        };
        
        tabs.Add(tab);
        activeTabId = tabId;
        
        await LoadTabData(tab);
    }
    
    private void OpenProjectTab(ProjectItem project)
    {
        var tabId = $"project_{++tabCounter}";
        var tab = new TabItem
        {
            Id = tabId,
            Title = project.Name,
            Type = "project",
            Project = project
        };
        
        tabs.Add(tab);
        activeTabId = tabId;
    }
    
    private async Task LoadTabData(TabItem tab)
    {
        if (tab.Type == "group")
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            var projectsResult = await gitlabClient.GetGroupProjectsAsync(tab.GroupId, pageSize, tab.CurrentPage);
            tab.Projects = projectsResult.Select(p => new ProjectItem
            {
                Id = p.Id,
                Name = p.Name,
                FullPath = p.PathWithNamespace,
                Description = p.Description ?? "",
                WebUrl = p.WebUrl
            }).ToList();
            tab.HasMoreProjects = projectsResult.Count == pageSize;
            
            var subgroupsResult = await gitlabClient.GetSubgroupsAsync(tab.GroupId, pageSize, tab.CurrentPage);
            tab.Subgroups = new List<SubgroupItem>();
            foreach (var g in subgroupsResult)
            {
                var subgroup = new SubgroupItem
                {
                    Id = g.Id,
                    Name = g.Name,
                    FullPath = g.FullPath,
                    Description = g.Description ?? "",
                    WebUrl = g.WebUrl
                };
                
                try
                {
                    var groupVars = await gitlabClient.GetGroupVariablesAsync(g.Id.ToString());
                    subgroup.Variables = new ProjectVariablesModel
                    {
                        TotalVariables = groupVars.Count,
                        ProtectedVariables = groupVars.Count(v => v.Protected),
                        MaskedVariables = groupVars.Count(v => v.Masked),
                        EnvironmentScopes = groupVars.Select(v => v.EnvironmentScope).Distinct().ToList(),
                        Variables = groupVars.Select(v => new ProjectVariableModel
                        {
                            Key = v.Key,
                            VariableType = v.VariableType,
                            Protected = v.Protected,
                            Masked = v.Masked,
                            EnvironmentScope = v.EnvironmentScope,
                            Description = v.Description
                        }).ToList()
                    };
                }
                catch
                {
                    // Ignore errors fetching group variables
                }
                
                tab.Subgroups.Add(subgroup);
            }
            tab.HasMoreSubgroups = subgroupsResult.Count == pageSize;
        }
    }
    
    private void SetActiveTab(string tabId)
    {
        activeTabId = tabId;
    }
    
    private void CloseTab(string tabId)
    {
        tabs.RemoveAll(t => t.Id == tabId);
        if (activeTabId == tabId)
        {
            activeTabId = tabs.Any() ? tabs.Last().Id : "main";
        }
    }
    
    private async Task NextTabPage(string tabId)
    {
        var tab = tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null)
        {
            LoadingService.SetLoading(true, "Loading next page...");
            try
            {
                tab.CurrentPage++;
                await LoadTabData(tab);
            }
            finally
            {
                LoadingService.SetLoading(false);
            }
        }
    }
    
    private async Task PreviousTabPage(string tabId)
    {
        var tab = tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null && tab.CurrentPage > 1)
        {
            LoadingService.SetLoading(true, "Loading previous page...");
            try
            {
                tab.CurrentPage--;
                await LoadTabData(tab);
            }
            finally
            {
                LoadingService.SetLoading(false);
            }
        }
    }

    private void BackToConnection()
    {
        projects = null;
        subgroups = null;
        analysisResult = null;
        groupName = null;
        mainGroupVariables = null;
        errorMessage = null;
        currentPage = 1;
        tabs.Clear();
        activeTabId = "main";
        tabCounter = 0;
        searchResults = null;
        searchTerm = string.Empty;
    }

    private void BackToProjects()
    {
        analysisResult = null;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSavedSettings();
    }
    
    private async Task LoadSavedSettings()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gitlab-instances");
            if (!string.IsNullOrEmpty(json))
            {
                var settings = System.Text.Json.JsonSerializer.Deserialize<GitLabSettingsModel>(json);
                if (settings?.Instances.Any() == true)
                {
                    var defaultInstance = settings.Instances.FirstOrDefault(i => i.Id == settings.DefaultInstanceId) ?? settings.Instances.First();
                    connectionModel.ServerUrl = defaultInstance.ServerUrl;
                    connectionModel.Token = defaultInstance.Token;
                    connectionModel.DefaultGroupId = defaultInstance.DefaultGroupId;
                    
                    if (string.IsNullOrEmpty(connectionModel.GroupId) && !string.IsNullOrEmpty(defaultInstance.DefaultGroupId))
                    {
                        connectionModel.GroupId = defaultInstance.DefaultGroupId;
                    }
                }
            }
            else
            {
                // Fallback to old format
                var oldJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gitlab-settings");
                if (!string.IsNullOrEmpty(oldJson))
                {
                    var saved = System.Text.Json.JsonSerializer.Deserialize<GitLabConnectionModel>(oldJson);
                    if (saved != null)
                    {
                        connectionModel.ServerUrl = saved.ServerUrl;
                        connectionModel.Token = saved.Token;
                        connectionModel.DefaultGroupId = saved.DefaultGroupId;
                        
                        if (string.IsNullOrEmpty(connectionModel.GroupId) && !string.IsNullOrEmpty(saved.DefaultGroupId))
                        {
                            connectionModel.GroupId = saved.DefaultGroupId;
                        }
                    }
                }
            }
        }
        catch
        {
            // Ignore errors loading settings
        }
    }


    
    private void ShowVariables(ProjectVariablesModel? variables)
    {
        selectedVariables = variables;
        showVariablesModal = true;
    }
    
    private void CloseVariablesModal()
    {
        showVariablesModal = false;
        selectedVariables = null;
    }
    
    private async Task ViewSamlLinks(string groupId, string groupName)
    {
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            var samlLinks = await gitlabClient.GetGroupSamlLinksAsync(groupId);
            selectedSamlLinks = samlLinks.Select(link => new SamlGroupLinkModel
            {
                SamlGroupName = link.SamlGroupName,
                AccessLevel = GetAccessLevelName(link.AccessLevel),
                ProviderName = link.Provider
            }).ToList();
            
            showSamlLinksModal = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load SAML links for {groupName}: {ex.Message}";
        }
    }
    
    private void CloseSamlLinksModal()
    {
        showSamlLinksModal = false;
        selectedSamlLinks = null;
    }
    
    private async Task ViewProvisionedUsers(string groupId, string groupName)
    {
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            selectedProvisionedUsers = await gitlabClient.GetGroupMembersAsync(groupId);
            showProvisionedUsersModal = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load provisioned users for {groupName}: {ex.Message}";
        }
    }
    
    private void CloseProvisionedUsersModal()
    {
        showProvisionedUsersModal = false;
        selectedProvisionedUsers = null;
    }
    
    private async Task ViewSamlUsers(string groupId, string groupName)
    {
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            selectedSamlUsers = await gitlabClient.GetGroupMembersAsync(groupId);
            showSamlUsersModal = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load SAML users for {groupName}: {ex.Message}";
        }
    }
    
    private void CloseSamlUsersModal()
    {
        showSamlUsersModal = false;
        selectedSamlUsers = null;
    }
    
    private string GetAccessLevelName(int accessLevel)
    {
        return accessLevel switch
        {
            10 => "Guest",
            20 => "Reporter",
            30 => "Developer",
            40 => "Maintainer",
            50 => "Owner",
            _ => accessLevel.ToString()
        };
    }
    
    private void ClearSearch()
    {
        searchResults = null;
        searchTerm = string.Empty;
    }
    
    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || string.IsNullOrWhiteSpace(connectionModel.Token))
            return;
            
        isSearching = true;
        errorMessage = null;
        LoadingService.SetLoading(true, $"Searching for '{searchTerm}'...");
        
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            LoadingService.SetLoading(true, "Searching projects...");
            var searchedProjects = await gitlabClient.SearchProjectsAsync(searchTerm, pageSize);
            
            LoadingService.SetLoading(true, "Searching groups...");
            var searchedGroups = await gitlabClient.SearchGroupsAsync(searchTerm, pageSize);
            
            searchResults = new SearchResultsModel
            {
                SearchTerm = searchTerm,
                Projects = searchedProjects.Select(p => new ProjectItem
                {
                    Id = p.Id,
                    Name = p.Name,
                    FullPath = p.PathWithNamespace,
                    Description = p.Description ?? "",
                    WebUrl = p.WebUrl
                }).ToList(),
                Groups = searchedGroups.Select(g => new GroupItem
                {
                    Id = g.Id,
                    Name = g.Name,
                    FullPath = g.FullPath,
                    Description = g.Description ?? "",
                    WebUrl = g.WebUrl
                }).ToList()
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Search failed: {ex.Message}";
        }
        finally
        {
            isSearching = false;
            LoadingService.SetLoading(false);
        }
    }
    
    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleSearch();
        }
    }
    
    private async Task ConnectToGroup(string groupId, string groupName)
    {
        connectionModel.GroupId = groupId;
        this.groupName = groupName;
        searchResults = null;
        searchTerm = string.Empty;
        
        isConnecting = true;
        LoadingService.SetLoading(true, $"Loading group {groupName}...");
        
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            GitLabProjectService.SetAuthenticatedClient(gitlabClient);
            
            // Get main group variables
            try
            {
                var groupVars = await gitlabClient.GetGroupVariablesAsync(connectionModel.GroupId);
                mainGroupVariables = new ProjectVariablesModel
                {
                    TotalVariables = groupVars.Count,
                    ProtectedVariables = groupVars.Count(v => v.Protected),
                    MaskedVariables = groupVars.Count(v => v.Masked),
                    EnvironmentScopes = groupVars.Select(v => v.EnvironmentScope).Distinct().ToList(),
                    Variables = groupVars.Select(v => new ProjectVariableModel
                    {
                        Key = v.Key,
                        VariableType = v.VariableType,
                        Protected = v.Protected,
                        Masked = v.Masked,
                        EnvironmentScope = v.EnvironmentScope,
                        Description = v.Description
                    }).ToList()
                };
            }
            catch
            {
                // Ignore errors fetching main group variables
            }
            
            LoadingService.SetLoading(true, "Loading projects and subgroups...");
            await LoadPageData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load group: {ex.Message}";
        }
        finally
        {
            isConnecting = false;
            LoadingService.SetLoading(false);
        }
    }
    
    private async Task ViewProjectVariables(string projectPath, string projectName)
    {
        isLoadingVariables = true;
        loadingVariablesFor = projectPath;
        
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            var projectVars = await gitlabClient.GetProjectVariablesAsync(projectPath);
            var variablesModel = new ProjectVariablesModel
            {
                TotalVariables = projectVars.Count,
                ProtectedVariables = projectVars.Count(v => v.Protected),
                MaskedVariables = projectVars.Count(v => v.Masked),
                EnvironmentScopes = projectVars.Select(v => v.EnvironmentScope).Distinct().ToList(),
                Variables = projectVars.Select(v => new ProjectVariableModel
                {
                    Key = v.Key,
                    Value = v.Value,
                    VariableType = v.VariableType,
                    Protected = v.Protected,
                    Masked = v.Masked,
                    EnvironmentScope = v.EnvironmentScope,
                    Description = v.Description
                }).ToList()
            };
            
            ShowVariables(variablesModel);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load variables for {projectName}: {ex.Message}";
        }
        finally
        {
            isLoadingVariables = false;
            loadingVariablesFor = null;
        }
    }
    
    private void ExportGroupJson(string groupId, string groupName)
    {
        exportGroupId = groupId;
        exportGroupName = groupName;
        showExportModal = true;
    }
    
    private void CloseExportModal()
    {
        showExportModal = false;
        exportGroupId = string.Empty;
        exportGroupName = string.Empty;
    }
    
    private async Task HandleGroupExport((string FilePath, string FileName, bool IncludeVariables, bool IncludeSamlLinks, bool IncludeSubgroups, bool IncludeProvisionedUsers) exportInfo)
    {
        showExportModal = false;
        LoadingService.SetLoading(true, $"Exporting {exportGroupName} JSON...");
        
        try
        {
            var gitlabClient = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(
                connectionModel.ServerUrl, 
                connectionModel.Token);
            
            var group = await gitlabClient.GetGroupAsync(exportGroupId);
            
            var exportData = new Dictionary<string, object>
            {
                ["id"] = group.Id,
                ["name"] = group.Name,
                ["path"] = group.Path,
                ["description"] = group.Description,
                ["visibility"] = "private",
                ["full_name"] = group.FullName,
                ["full_path"] = group.FullPath,
                ["web_url"] = group.WebUrl,
                ["parent_id"] = (int?)null
            };
            
            if (exportInfo.IncludeVariables)
            {
                try
                {
                    LoadingService.SetLoading(true, "Fetching CI/CD variables...");
                    var variables = await gitlabClient.GetGroupVariablesAsync(exportGroupId);
                    exportData["variables"] = variables.Select(v => new
                    {
                        key = v.Key,
                        value = v.Value,
                        variable_type = v.VariableType,
                        @protected = v.Protected,
                        masked = v.Masked,
                        raw = v.Raw,
                        environment_scope = v.EnvironmentScope,
                        description = v.Description
                    }).ToList();
                }
                catch
                {
                    exportData["variables"] = new List<object>();
                }
            }
            
            if (exportInfo.IncludeSamlLinks)
            {
                try
                {
                    LoadingService.SetLoading(true, "Fetching SAML links...");
                    var samlLinks = await gitlabClient.GetGroupSamlLinksAsync(exportGroupId);
                    exportData["saml_group_links"] = samlLinks.Select(s => new
                    {
                        name = s.SamlGroupName,
                        access_level = s.AccessLevel,
                        member_role_id = s.MemberRoleId,
                        provider = s.Provider
                    }).ToList();
                }
                catch
                {
                    exportData["saml_group_links"] = new List<object>();
                }
            }
            
            if (exportInfo.IncludeSubgroups)
            {
                try
                {
                    LoadingService.SetLoading(true, "Fetching subgroups...");
                    var subgroups = await gitlabClient.GetSubgroupsAsync(exportGroupId, 100, 1);
                    exportData["subgroups"] = subgroups.Select(sg => new
                    {
                        id = sg.Id,
                        name = sg.Name,
                        path = sg.Path,
                        description = sg.Description,
                        full_name = sg.FullName,
                        full_path = sg.FullPath,
                        web_url = sg.WebUrl
                    }).ToList();
                }
                catch
                {
                    exportData["subgroups"] = new List<object>();
                }
            }
            
            if (exportInfo.IncludeProvisionedUsers)
            {
                try
                {
                    LoadingService.SetLoading(true, "Fetching provisioned users...");
                    var members = await gitlabClient.GetGroupMembersAsync(exportGroupId);
                    exportData["provisioned_users"] = members.Select(m => new
                    {
                        id = m.Id,
                        username = m.Username,
                        name = m.Name,
                        email = m.Email,
                        access_level = m.AccessLevel,
                        expires_at = m.ExpiresAt
                    }).ToList();
                }
                catch
                {
                    exportData["provisioned_users"] = new List<object>();
                }
            }
            
            var json = System.Text.Json.JsonSerializer.Serialize(exportData, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            
            if (exportInfo.FilePath == "fileHandle" && exportModal != null)
            {
                // Use File System Access API
                await exportModal.WriteToSelectedFile(json);
            }
            else
            {
                // Fallback to download
                await JSRuntime.InvokeVoidAsync("eval", $@"
                    const blob = new Blob([{System.Text.Json.JsonSerializer.Serialize(json)}], {{ type: 'application/json' }});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '{exportInfo.FileName}';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                ");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export group JSON for {exportGroupName}: {ex.Message}";
        }
        finally
        {
            LoadingService.SetLoading(false);
        }
    }
    
    public class SearchResultsModel
    {
        public string SearchTerm { get; set; } = string.Empty;
        public List<ProjectItem> Projects { get; set; } = new();
        public List<GroupItem> Groups { get; set; } = new();
    }
    
    public class GroupItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string FullPath { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string WebUrl { get; set; } = string.Empty;
    }
}