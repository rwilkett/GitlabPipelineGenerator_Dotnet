@page "/reports"
@using GitlabPipelineGenerator.Web.Models
@using GitlabPipelineGenerator.Web.Services
@inject IJSRuntime JSRuntime
@inject LoadingService LoadingService

<PageTitle>Reports</PageTitle>

<h1>Reports</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>CI/CD Variables by Group/Project</h4>
            </div>
            <div class="card-body">
                <p>Generate a report showing CI/CD variable counts for all subgroups and projects.</p>
                <button class="btn btn-primary" @onclick="GenerateVariablesReport" disabled="@isGenerating">
                    @if (isGenerating)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Generating...</span>
                    }
                    else
                    {
                        <span>Generate Report</span>
                    }
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>Pipeline runs by date range</h4>
            </div>
            <div class="card-body">
                <p>Generate a report showing pipeline run counts by project within a date range.</p>
                <div class="mb-3">
                    <label class="form-label">Start Date:</label>
                    <input type="date" class="form-control" @bind="startDate" />
                </div>
                <div class="mb-3">
                    <label class="form-label">End Date:</label>
                    <input type="date" class="form-control" @bind="endDate" />
                </div>
                <button class="btn btn-primary" @onclick="GeneratePipelineRunsReport" disabled="@isGeneratingPipelines">
                    @if (isGeneratingPipelines)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Generating...</span>
                    }
                    else
                    {
                        <span>Generate Report</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@if (variablesReport != null)
{
    <div class="mt-4">
        <h2>CI/CD Variables by Group/Project</h2>
        <p><strong>Top-level Group:</strong> @variablesReport.GroupName</p>
        
        @if (variablesReport.Groups.Any())
        {
            <h3>Subgroups</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Full Path</th>
                        <th>Variable Count</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var group in variablesReport.Groups.OrderBy(g => g.FullPath))
                    {
                        <tr>
                            <td>@group.Name</td>
                            <td>@group.FullPath</td>
                            <td>@group.VariableCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        
        @if (variablesReport.Projects.Any())
        {
            <h3>Projects</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Project Name</th>
                        <th>Full Path</th>
                        <th>Variable Count</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var project in variablesReport.Projects.OrderBy(p => p.FullPath))
                    {
                        <tr>
                            <td>@project.Name</td>
                            <td>@project.FullPath</td>
                            <td>@project.VariableCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
}

@if (pipelineRunsReport != null)
{
    <div class="mt-4">
        <h2>Pipeline runs by date range</h2>
        <p><strong>Top-level Group:</strong> @pipelineRunsReport.GroupName</p>
        <p><strong>Date Range:</strong> @pipelineRunsReport.StartDate.ToString("yyyy-MM-dd") to @pipelineRunsReport.EndDate.ToString("yyyy-MM-dd")</p>
        
        @foreach (var group in pipelineRunsReport.Groups.OrderBy(g => g.GroupPath))
        {
            <div class="mb-4">
                <h3>@group.GroupName (@group.GroupPath)</h3>
                @if (group.Projects.Any())
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Full Path</th>
                                <th>Pipeline Runs</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in group.Projects.OrderBy(p => p.FullPath))
                            {
                                <tr>
                                    <td>@project.Name</td>
                                    <td>@project.FullPath</td>
                                    <td>@project.PipelineCount</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">No projects found in this group.</p>
                }
            </div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3">@errorMessage</div>
}

@code {
    private VariablesReportModel? variablesReport;
    private PipelineRunsReportModel? pipelineRunsReport;
    private bool isGenerating = false;
    private bool isGeneratingPipelines = false;
    private string? errorMessage;
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private DateTime endDate = DateTime.Today;

    private async Task GenerateVariablesReport()
    {
        isGenerating = true;
        errorMessage = null;
        LoadingService.SetLoading(true, "Loading GitLab settings...");

        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gitlab-settings");
            if (string.IsNullOrEmpty(json))
            {
                errorMessage = "No GitLab settings found. Please configure GitLab connection in Settings.";
                return;
            }

            var settings = System.Text.Json.JsonSerializer.Deserialize<GitLabConnectionModel>(json);
            if (settings == null || string.IsNullOrEmpty(settings.Token) || string.IsNullOrEmpty(settings.DefaultGroupId))
            {
                errorMessage = "GitLab token or default group ID not configured. Please check Settings.";
                return;
            }

            LoadingService.SetLoading(true, "Connecting to GitLab...");
            var client = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(settings.ServerUrl, settings.Token);
            
            LoadingService.SetLoading(true, "Loading group information...");
            var group = await client.GetGroupAsync(settings.DefaultGroupId);
            
            var report = new VariablesReportModel { GroupName = group.Name };
            
            LoadingService.SetLoading(true, "Loading subgroups...");
            var subgroups = await client.GetSubgroupsAsync(settings.DefaultGroupId, 100, 1);
            
            foreach (var subgroup in subgroups)
            {
                try
                {
                    var variables = await client.GetGroupVariablesAsync(subgroup.Id.ToString());
                    report.Groups.Add(new GroupVariablesSummary
                    {
                        Name = subgroup.Name,
                        FullPath = subgroup.FullPath,
                        VariableCount = variables.Count
                    });
                }
                catch
                {
                    report.Groups.Add(new GroupVariablesSummary
                    {
                        Name = subgroup.Name,
                        FullPath = subgroup.FullPath,
                        VariableCount = 0
                    });
                }
            }
            
            LoadingService.SetLoading(true, "Loading projects...");
            var projects = await client.GetGroupProjectsAsync(settings.DefaultGroupId, 100, 1);
            
            foreach (var project in projects)
            {
                try
                {
                    var variables = await client.GetProjectVariablesAsync(project.Id.ToString());
                    report.Projects.Add(new ProjectVariablesSummary
                    {
                        Name = project.Name,
                        FullPath = project.PathWithNamespace,
                        VariableCount = variables.Count
                    });
                }
                catch
                {
                    report.Projects.Add(new ProjectVariablesSummary
                    {
                        Name = project.Name,
                        FullPath = project.PathWithNamespace,
                        VariableCount = 0
                    });
                }
            }
            
            variablesReport = report;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating report: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            LoadingService.SetLoading(false);
        }
    }

    private async Task GeneratePipelineRunsReport()
    {
        isGeneratingPipelines = true;
        errorMessage = null;
        LoadingService.SetLoading(true, "Loading GitLab settings...");

        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "gitlab-settings");
            if (string.IsNullOrEmpty(json))
            {
                errorMessage = "No GitLab settings found. Please configure GitLab connection in Settings.";
                return;
            }

            var settings = System.Text.Json.JsonSerializer.Deserialize<GitLabConnectionModel>(json);
            if (settings == null || string.IsNullOrEmpty(settings.Token) || string.IsNullOrEmpty(settings.DefaultGroupId))
            {
                errorMessage = "GitLab token or default group ID not configured. Please check Settings.";
                return;
            }

            LoadingService.SetLoading(true, "Connecting to GitLab...");
            var client = new GitlabPipelineGenerator.GitLabApiClient.GitLabClient(settings.ServerUrl, settings.Token);
            
            LoadingService.SetLoading(true, "Loading group information...");
            var group = await client.GetGroupAsync(settings.DefaultGroupId);
            
            var report = new PipelineRunsReportModel 
            { 
                GroupName = group.Name,
                StartDate = startDate,
                EndDate = endDate
            };
            
            LoadingService.SetLoading(true, "Loading subgroups and projects...");
            var subgroups = await client.GetSubgroupsAsync(settings.DefaultGroupId, 100, 1);
            
            // Add main group projects
            var mainGroupProjects = await client.GetGroupProjectsAsync(settings.DefaultGroupId, 100, 1);
            if (mainGroupProjects.Any())
            {
                var mainGroup = new GroupPipelineRuns
                {
                    GroupName = group.Name,
                    GroupPath = group.FullPath
                };
                
                foreach (var project in mainGroupProjects)
                {
                    LoadingService.SetLoading(true, $"Loading pipelines for {project.Name}...");
                    try
                    {
                        var pipelines = await client.GetProjectPipelinesAsync(project.Id.ToString(), startDate, endDate);
                        mainGroup.Projects.Add(new ProjectPipelineRuns
                        {
                            Name = project.Name,
                            FullPath = project.PathWithNamespace,
                            PipelineCount = pipelines.Count
                        });
                    }
                    catch
                    {
                        mainGroup.Projects.Add(new ProjectPipelineRuns
                        {
                            Name = project.Name,
                            FullPath = project.PathWithNamespace,
                            PipelineCount = 0
                        });
                    }
                }
                report.Groups.Add(mainGroup);
            }
            
            // Add subgroup projects
            foreach (var subgroup in subgroups)
            {
                var groupProjects = await client.GetGroupProjectsAsync(subgroup.Id.ToString(), 100, 1);
                if (groupProjects.Any())
                {
                    var groupRuns = new GroupPipelineRuns
                    {
                        GroupName = subgroup.Name,
                        GroupPath = subgroup.FullPath
                    };
                    
                    foreach (var project in groupProjects)
                    {
                        LoadingService.SetLoading(true, $"Loading pipelines for {project.Name}...");
                        try
                        {
                            var pipelines = await client.GetProjectPipelinesAsync(project.Id.ToString(), startDate, endDate);
                            groupRuns.Projects.Add(new ProjectPipelineRuns
                            {
                                Name = project.Name,
                                FullPath = project.PathWithNamespace,
                                PipelineCount = pipelines.Count
                            });
                        }
                        catch
                        {
                            groupRuns.Projects.Add(new ProjectPipelineRuns
                            {
                                Name = project.Name,
                                FullPath = project.PathWithNamespace,
                                PipelineCount = 0
                            });
                        }
                    }
                    report.Groups.Add(groupRuns);
                }
            }
            
            pipelineRunsReport = report;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating pipeline runs report: {ex.Message}";
        }
        finally
        {
            isGeneratingPipelines = false;
            LoadingService.SetLoading(false);
        }
    }
}